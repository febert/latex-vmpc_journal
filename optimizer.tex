\section{Trajectory Optimizer}

\begin{algorithm}[ht]
\caption{Trajecotry Optimization in Visual MPC}
\label{sarsalambdafa}
\begin{algorithmic}[1]
\State \textbf{Inputs:} Predictive Model $g$, task definition i.e. designated-pixel goal-pixel pair or goal-image
\For{$t~=~0...T-1$}

\For{$i~=~0...n_{iter}-1$}
\If{$i==0$}
\State \begin{varwidth}[t]{\linewidth}
	Sample $M$ action sequences $\{a^{(m)}_{t:t+H-1}\}$ from \par $\mathcal N(0, I)$ or
	custom sampling distribution
\end{varwidth}
\Else
\State \begin{varwidth}[t]{\linewidth}
	Sample $M$ action sequences ${a^{(m)}_{t:t+H-1}}$ from \par 
	$\mathcal N(\mu^{(i)}, \Sigma^{(i)})$
\end{varwidth}
\EndIf
\State  \begin{varwidth}[t]{\linewidth}
	Use model $g$ to predict future sequences of images $\hat{I}_{t:t+H-1}$ and probability distributions $\hat{P}_{t:t+H-1}$
\end{varwidth}
\State Rank the action sequences using a cost function $c$
\State  \begin{varwidth}[t]{\linewidth}
	Fit a Gaussian to the $k$ best action samples \par 
	yielding $\mu^{(i)}, \Sigma^{(i)}$
\end{varwidth}
\EndFor
\EndFor
\end{algorithmic}
\end{algorithm}


\label{sec:optimizer}
The role of the optimizer is to find actions sequences $a_{1:T}$ which minimize the sum of the costs $c_{1:T}$ along the planning horizon $T$ by sampling a large number of actions sequences and ranking of each video-prediction rollout using a cost function.

To render the planning process more efficient, we use the cross-entropy method (CEM), a gradient-free optimization procedure.
CEM consists of iteratively resampling action sequences and refitting Gaussian distributions to the actions with the best predicted cost. 
We extend CEM to handle a mixture of continuous and discrete actions.

The motivation for using a gradient-free, sampling-based optimizer is that in this way we can easily ensure that actions stay within the distribution of actions the model has encountered during training. This is crucial to ensure that the model does not receive out-of-distribution inputs and makes valid predictions. 

In the appendix \ref{sec:cem_improv} we explain a few improvements we made to the CEM-optimizer.